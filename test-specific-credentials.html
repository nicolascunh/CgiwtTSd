<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Credenciais Espec√≠ficas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }
        .test-icon {
            font-size: 24px;
            margin-right: 12px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .test-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 12px;
        }
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #f5f5f5;
        }
        .btn-primary {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .log-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin-bottom: 4px;
            padding: 4px;
            border-radius: 2px;
        }
        .log-success {
            background-color: #d4edda;
            color: #155724;
        }
        .log-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .log-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .log-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 16px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste - Credenciais Espec√≠ficas</h1>
        <p>Testando credenciais: <strong>mfrastreamentook@hotmail.com:987036752</strong></p>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalDevices">0</div>
                <div class="stat-label">Total de Dispositivos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="successfulRequests">0</div>
                <div class="stat-label">Requisi√ß√µes Bem-sucedidas</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="failedRequests">0</div>
                <div class="stat-label">Requisi√ß√µes Falharam</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="rateLimitHits">0</div>
                <div class="stat-label">Rate Limits (429)</div>
            </div>
        </div>

        <h2 class="section-title">üß™ Testes de Conectividade</h2>
        
        <div class="test-section">
            <div class="test-header">
                <div class="test-icon">üîê</div>
                <div class="test-title">Teste de Autentica√ß√£o</div>
            </div>
            <div class="test-description">
                Testa se as credenciais funcionam com diferentes endpoints.
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testAuth()">Testar /api/server</button>
                <button class="btn btn-primary" onclick="testDevices()">Testar /api/devices</button>
                <button class="btn btn-primary" onclick="testPositions()">Testar /api/positions</button>
            </div>
            <div class="log-container" id="authLog"></div>
        </div>

        <div class="test-section">
            <div class="test-header">
                <div class="test-icon">‚ö°</div>
                <div class="test-title">Teste de Rate Limit</div>
            </div>
            <div class="test-description">
                Testa quantas requisi√ß√µes podem ser feitas por minuto sem erro 429.
            </div>
            <div class="button-group">
                <button class="btn btn-success" onclick="testRateLimit()">Testar Rate Limit</button>
                <button class="btn btn-warning" onclick="testBurstRequests()">Testar Requisi√ß√µes em Lote</button>
                <button class="btn btn-danger" onclick="stopTests()">Parar Testes</button>
            </div>
            <div class="log-container" id="rateLimitLog"></div>
        </div>

        <div class="test-section">
            <div class="test-header">
                <div class="test-icon">üìä</div>
                <div class="test-title">Teste de Performance</div>
            </div>
            <div class="test-description">
                Testa a performance com diferentes tamanhos de lote e delays.
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="testSmallBatches()">Lotes Pequenos (5)</button>
                <button class="btn btn-primary" onclick="testMediumBatches()">Lotes M√©dios (10)</button>
                <button class="btn btn-primary" onclick="testLargeBatches()">Lotes Grandes (20)</button>
            </div>
            <div class="log-container" id="performanceLog"></div>
        </div>

        <div class="test-section">
            <div class="test-header">
                <div class="test-icon">üîß</div>
                <div class="test-title">Otimiza√ß√µes Sugeridas</div>
            </div>
            <div class="test-description">
                Baseado nos testes, sugest√µes para melhorar a performance.
            </div>
            <div class="log-container" id="suggestionsLog"></div>
        </div>
    </div>

    <script>
        const credentials = 'mfrastreamentook@hotmail.com:987036752';
        const base64Credentials = btoa(credentials);
        const API_BASE_URL = 'https://trackmax-proxy.trackmax-proxy.workers.dev/api';
        
        let testRunning = false;
        let requestCount = 0;
        let successCount = 0;
        let failureCount = 0;
        let rateLimitCount = 0;
        let deviceCount = 0;

        function log(message, type = 'info', containerId = 'authLog') {
            const container = document.getElementById(containerId);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        function updateStats() {
            document.getElementById('totalDevices').textContent = deviceCount.toLocaleString();
            document.getElementById('successfulRequests').textContent = successCount.toLocaleString();
            document.getElementById('failedRequests').textContent = failureCount.toLocaleString();
            document.getElementById('rateLimitHits').textContent = rateLimitCount.toLocaleString();
        }

        async function makeRequest(url, options = {}) {
            requestCount++;
            const startTime = Date.now();
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Authorization': `Basic ${base64Credentials}`,
                        'Accept': 'application/json',
                        ...options.headers
                    }
                });
                
                const duration = Date.now() - startTime;
                
                if (response.ok) {
                    successCount++;
                    log(`‚úÖ ${response.status} - ${duration}ms - ${url}`, 'success');
                    return { success: true, data: await response.json(), duration };
                } else if (response.status === 429) {
                    rateLimitCount++;
                    log(`üö´ 429 Rate Limit - ${duration}ms - ${url}`, 'error');
                    return { success: false, error: 'Rate Limit', status: 429 };
                } else {
                    failureCount++;
                    log(`‚ùå ${response.status} - ${duration}ms - ${url}`, 'error');
                    return { success: false, error: `HTTP ${response.status}`, status: response.status };
                }
            } catch (error) {
                failureCount++;
                log(`üí• Erro: ${error.message}`, 'error');
                return { success: false, error: error.message };
            } finally {
                updateStats();
            }
        }

        async function testAuth() {
            log('üîê Testando autentica√ß√£o...', 'info');
            const result = await makeRequest(`${API_BASE_URL}/server`);
            if (result.success) {
                log(`‚úÖ Autentica√ß√£o bem-sucedida! Servidor: ${result.data.server || 'N/A'}`, 'success');
            }
        }

        async function testDevices() {
            log('üì± Testando busca de dispositivos...', 'info');
            const result = await makeRequest(`${API_BASE_URL}/devices?limit=10`);
            if (result.success) {
                deviceCount = result.data.length;
                log(`‚úÖ ${deviceCount} dispositivos encontrados`, 'success');
                updateStats();
            }
        }

        async function testPositions() {
            log('üìç Testando busca de posi√ß√µes...', 'info');
            const result = await makeRequest(`${API_BASE_URL}/positions?limit=10`);
            if (result.success) {
                log(`‚úÖ ${result.data.length} posi√ß√µes encontradas`, 'success');
            }
        }

        async function testRateLimit() {
            if (testRunning) return;
            testRunning = true;
            log('‚ö° Iniciando teste de rate limit...', 'info', 'rateLimitLog');
            
            const requests = [];
            const startTime = Date.now();
            
            // Fazer 20 requisi√ß√µes em sequ√™ncia r√°pida
            for (let i = 0; i < 20; i++) {
                requests.push(makeRequest(`${API_BASE_URL}/server`));
                await new Promise(resolve => setTimeout(resolve, 100)); // 100ms entre requisi√ß√µes
            }
            
            const results = await Promise.all(requests);
            const duration = Date.now() - startTime;
            
            const successful = results.filter(r => r.success).length;
            const rateLimited = results.filter(r => r.status === 429).length;
            
            log(`üìä Resultado: ${successful}/20 sucessos, ${rateLimited} rate limits em ${duration}ms`, 'info', 'rateLimitLog');
            
            if (rateLimited > 0) {
                log(`‚ö†Ô∏è Rate limit detectado ap√≥s ${successful} requisi√ß√µes`, 'warning', 'rateLimitLog');
                log(`üí° Sugest√£o: Usar delays de ${Math.ceil(60000 / successful)}ms entre requisi√ß√µes`, 'info', 'suggestionsLog');
            } else {
                log(`‚úÖ Nenhum rate limit detectado!`, 'success', 'rateLimitLog');
                log(`üí° Sugest√£o: Pode usar delays menores (500ms-1s)`, 'info', 'suggestionsLog');
            }
            
            testRunning = false;
        }

        async function testBurstRequests() {
            if (testRunning) return;
            testRunning = true;
            log('üöÄ Testando requisi√ß√µes em rajada...', 'info', 'rateLimitLog');
            
            const startTime = Date.now();
            const requests = [];
            
            // Fazer 50 requisi√ß√µes simult√¢neas
            for (let i = 0; i < 50; i++) {
                requests.push(makeRequest(`${API_BASE_URL}/server`));
            }
            
            const results = await Promise.all(requests);
            const duration = Date.now() - startTime;
            
            const successful = results.filter(r => r.success).length;
            const rateLimited = results.filter(r => r.status === 429).length;
            
            log(`üìä Rajada: ${successful}/50 sucessos, ${rateLimited} rate limits em ${duration}ms`, 'info', 'rateLimitLog');
            
            if (rateLimited > 0) {
                log(`‚ö†Ô∏è Rate limit severo com requisi√ß√µes simult√¢neas`, 'warning', 'rateLimitLog');
                log(`üí° Sugest√£o: Processar sequencialmente com delays`, 'info', 'suggestionsLog');
            }
            
            testRunning = false;
        }

        async function testSmallBatches() {
            log('üì¶ Testando lotes pequenos (5 dispositivos)...', 'info', 'performanceLog');
            await testBatchSize(5, 2000);
        }

        async function testMediumBatches() {
            log('üì¶ Testando lotes m√©dios (10 dispositivos)...', 'info', 'performanceLog');
            await testBatchSize(10, 3000);
        }

        async function testLargeBatches() {
            log('üì¶ Testando lotes grandes (20 dispositivos)...', 'info', 'performanceLog');
            await testBatchSize(20, 5000);
        }

        async function testBatchSize(batchSize, delay) {
            const startTime = Date.now();
            let successCount = 0;
            let errorCount = 0;
            
            // Simular 3 lotes
            for (let batch = 0; batch < 3; batch++) {
                log(`üîÑ Processando lote ${batch + 1}/3 (${batchSize} dispositivos)...`, 'info', 'performanceLog');
                
                const requests = [];
                for (let i = 0; i < batchSize; i++) {
                    requests.push(makeRequest(`${API_BASE_URL}/server`));
                }
                
                const results = await Promise.all(requests);
                const batchSuccess = results.filter(r => r.success).length;
                const batchErrors = results.filter(r => !r.success).length;
                
                successCount += batchSuccess;
                errorCount += batchErrors;
                
                log(`‚úÖ Lote ${batch + 1}: ${batchSuccess}/${batchSize} sucessos`, 'success', 'performanceLog');
                
                if (batch < 2) { // N√£o aguardar ap√≥s o √∫ltimo lote
                    log(`‚è≥ Aguardando ${delay}ms...`, 'info', 'performanceLog');
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            
            const duration = Date.now() - startTime;
            const totalRequests = batchSize * 3;
            
            log(`üìä Resultado: ${successCount}/${totalRequests} sucessos em ${duration}ms`, 'info', 'performanceLog');
            log(`üìà Taxa de sucesso: ${Math.round((successCount / totalRequests) * 100)}%`, 'info', 'performanceLog');
            
            if (errorCount > 0) {
                log(`‚ö†Ô∏è ${errorCount} erros detectados`, 'warning', 'performanceLog');
            } else {
                log(`‚úÖ Nenhum erro detectado!`, 'success', 'performanceLog');
            }
        }

        function stopTests() {
            testRunning = false;
            log('‚èπÔ∏è Testes interrompidos', 'warning', 'rateLimitLog');
        }

        // Inicializar
        log('üöÄ Teste de credenciais espec√≠ficas iniciado', 'info');
        log(`üîê Credenciais: ${credentials}`, 'info');
        log(`üåê API: ${API_BASE_URL}`, 'info');
        
        console.log('üîç Teste de credenciais espec√≠ficas carregado');
        console.log('üîê Credenciais:', credentials);
        console.log('üåê API Base:', API_BASE_URL);
    </script>
</body>
</html>



